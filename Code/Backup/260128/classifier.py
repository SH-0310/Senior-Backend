import pymysql
import logging
import requests
from utils import get_db_connection

# --- í…”ë ˆê·¸ë¨ ì„¤ì • ---
TELEGRAM_TOKEN = "8543857876:AAFs2kEURQEihK6_j6mw2PPaKQO4gYoBoSM"
CHAT_ID = "8305877092"

# âœ… 5070 ì‹œë‹ˆì–´ UXì— ìµœì í™”ëœ 8ëŒ€ ê¶Œì—­ ê¸°ë°˜ LOCATION_MAP
LOCATION_MAP = {
    "ì„œìš¸ / ì¸ì²œ": {
        "ì„œìš¸": ["ì„œìš¸", "ì²­ì™€ëŒ€", "ê²½ë³µê¶", "ë‚¨ì‚°", "ì¸ì‚¬ë™", "ê´‘ì¥ì‹œì¥"],
        "ì¸ì²œ": ["ì¸ì²œ", "ì›”ë¯¸ë„", "ê°œí•­ì¥", "ë¬´ì˜ë„", "ì°¨ì´ë‚˜íƒ€ìš´"],
        "ê°•í™”": ["ê°•í™”", "ì„ëª¨ë„", "êµë™ë„"]
    },
    "ê²½ê¸°ë„": {
        "ì–‘ì£¼": ["ì–‘ì£¼", "ë‚˜ë¦¬ë†ì›"],
        "ê°€í‰": ["ê°€í‰", "ì–´ë¹„ê³„ê³¡", "ì•„ì¹¨ê³ ìš”", "ì˜ë í”„ë‘ìŠ¤", "ìŠ¤ìœ„ìŠ¤ë§ˆì„"],
        "ì—¬ì£¼": ["ì—¬ì£¼", "ì‹ ë¥µì‚¬", "ì„¸ì¢…ëŒ€ì™•", "íŒŒì‚¬ì„±"],
        "ì˜¤ì‚°": ["ì˜¤ì‚°", "ë¬¼í–¥ê¸°"],
        "ìˆ˜ì›": ["ìˆ˜ì›", "í™”ì„±", "ìœµê±´ë¦‰"],
        "ì•ˆì„±": ["ì•ˆì„±", "íŒœëœë“œ"],
        "í¬ì²œ": ["í¬ì²œ", "ì•„íŠ¸ë°¸ë¦¬", "ì‚°ì •í˜¸ìˆ˜"],
        "íŒŒì£¼": ["íŒŒì£¼", "ë§ˆì¥í˜¸ìˆ˜", "ì„ì§„ê°", "í—¤ì´ë¦¬"],
        "ìš©ì¸": ["ìš©ì¸", "ì—ë²„ëœë“œ", "ë¯¼ì†ì´Œ"],
        "ì•ˆì‚°": ["ì œë¶€ë„", "ëŒ€ë¶€ë„", "ì„ ì¬ë„"]
    },
    "ê°•ì›ë„": {
        "íƒœë°±": ["íƒœë°±", "ëˆˆì¶•ì œ", "êµ¬ë¬¸ì†Œ", "ì² ì•”", "í†µë¦¬", "ìš´íƒ„ê³ ë„", "í™©ì§€ì—°ëª»", "í•¨ë°±ì‚°", "ë§Œí•­ì¬", "ë‹¹ê³¨", "é›ªì™•é›ªë˜"],
        "ì¸ì œ": ["ì¸ì œ", "ì›ëŒ€ë¦¬", "ìì‘ë‚˜ë¬´"],
        "ê°•ë¦‰": ["ê°•ë¦‰", "ì •ë™ì§„", "ì£¼ë¬¸ì§„", "ê²½í¬ëŒ€", "ë°”ë‹¤ì—´ì°¨"],
        "ì†ì´ˆ": ["ì†ì´ˆ", "ì„¤ì•…ì‚°", "ëŒ€í¬í•­"],
        "ì¶˜ì²œ": ["ì¶˜ì²œ", "ë‚¨ì´ì„¬", "ì†Œì–‘ê°•"],
        "í‰ì°½": ["í‰ì°½", "ëŒ€ê´€ë ¹", "ì–‘ë–¼ë†ì¥", "ì›”ì •ì‚¬"],
        "ì›ì£¼": ["ì›ì£¼", "ì†Œê¸ˆì‚°", "ì¶œë ë‹¤ë¦¬", "ë°˜ê³„ë¦¬"],
        "ì² ì›": ["ì² ì›", "ê³ ì„ì •", "ì£¼ìƒì ˆë¦¬"],
        "í™”ì²œ": ["í™”ì²œ", "ì‚°ì²œì–´", "í‰í™”ì˜ëŒ"],
        "ì˜ì›”": ["ì˜ì›”", "ì²­ë ¹í¬", "ì„ ëŒ", "ëˆˆê½ƒì—´ì°¨"],
        "ê³ ì„±": ["ê³ ì„±", "í™”ì§„í¬", "ì•„ì•¼ì§„", "í•´íŒŒë‘ê¸¸"],
        "ì‚¼ì²™": ["ì‚¼ì²™", "í™˜ì„ êµ´", "ì¶”ì•”"],
        "ì •ì„ ": ["ì •ì„ ", "í™”ì•”ë™êµ´", "ì•„ë¼ë¦¬ì´Œ", "ë¯¼ë‘¥ì‚°"],
        "ì–‘êµ¬": ["ì–‘êµ¬", "ë‘íƒ€ì—°"],
        "ê°•ì›ì „ì²´": ["ê°•ì›ë„", "ê°•ì›ê¶Œ"]
    },
    "ì¶©ì²­ë„": {
        "ëŒ€ì „": ["ëŒ€ì „", "ì¥íƒœì‚°", "ì„±ì‹¬ë‹¹", "ì–¼ìŒë™ì‚°", "ìƒì†Œë™", "ìš°ì•”ì‚¬ì ", "ëª…ìƒì •ì›"],
        "ê³µì£¼": ["ê³µì£¼", "êµ°ë°¤ì¶•ì œ", "ë¬´ë ¹ì™•ë¦‰", "ê³µì‚°ì„±"],
        "ë¶€ì—¬": ["ë¶€ì—¬", "ë°±ì œ", "ê¶ë‚¨ì§€", "ë‚™í™”ì•”", "ë¶€ì†Œì‚°ì„±", "ì„œë™", "ì—°ê½ƒì¶•ì œ"],
        "ì˜ë™": ["ì˜ë™", "ê³¶ê°ì¶•ì œ", "ê³¼ì¼ë‚˜ë¼"],
        "ì§„ì²œ": ["ì§„ì²œ", "ë†ë‹¤ë¦¬", "ë°°í‹°ì„±ì§€"],
        "í™ì„±": ["í™ì„±", "ë‚¨ë‹¹í•­", "ìƒˆì¡°ê°œ", "ì†ë™", "í™ì£¼ì„±", "ì²œë¶"],
        "ì˜ˆì‚°": ["ì˜ˆì‚°", "ìˆ˜ë•ì‚¬", "ìŠ¤ì¹´ì´íƒ€ì›Œ"],
        "ì²­ì–‘": ["ì²­ì–‘", "ì–¼ìŒë¶„ìˆ˜", "ì¹ ê°‘"],
        "ê¸ˆì‚°": ["ê¸ˆì‚°", "ì¸ì‚¼ê´€", "í•˜ëŠ˜ë¬¼ë¹›ì •ì›"],
        "ì„œì²œ": ["ì„œì²œ", "ì¶˜ì¥ëŒ€", "ë§ˆëŸ‰í¬êµ¬", "ë™ë°±ë‚˜ë¬´ìˆ²"],
        "ë‹¨ì–‘": ["ë‹¨ì–‘", "ë§Œì²œí•˜", "ê³ ìˆ˜ë™êµ´"],
        "ì œì²œ": ["ì œì²œ", "ì²­í’í˜¸", "ì˜ë¦¼ì§€"],
        "íƒœì•ˆ": ["íƒœì•ˆ", "ì•ˆë©´ë„", "ê½ƒì§€"],
        "ë³´ë ¹": ["ë³´ë ¹", "ëŒ€ì²œ"]
    },
    "ì „ë¼ë„ (ì „ì£¼/ì—¬ìˆ˜)": {
        "ë¬´ì£¼": ["ë¬´ì£¼", "ë•ìœ ì‚°", "í–¥ì ë´‰", "êµ¬ì²œë™"],
        "ì •ì": ["ì •ì", "ë‚´ì¥ì‚°", "ìŒí™”ì°¨", "ë¯¸ìˆ ê´€"],
        "ìˆœì°½": ["ìˆœì°½", "ê°•ì²œì‚¬", "ê¸ˆì„±ì‚°ì„±"],
        "ë‚¨ì›": ["ë‚¨ì›", "ê´‘í•œë£¨", "ì§€ë¦¬ì‚°", "ë°”ë˜ë´‰", "ì„œë„ì—­"],
        "êµ°ì‚°": ["êµ°ì‚°", "ì„ ìœ ë„", "ì¥ìë„"],
        "ì „ì£¼": ["ì „ì£¼", "í•œì˜¥ë§ˆì„"],
        "ë¶€ì•ˆ": ["ë¶€ì•ˆ", "ì±„ì„ê°•"],
        "ê³ ì°½": ["ê³ ì°½", "ì„ ìš´ì‚¬", "ì²­ë³´ë¦¬"],
        "ê´‘ì–‘": ["ê´‘ì–‘", "ì˜¥ë£¡ì‚¬", "ë§¤í™”"],
        "ë‹´ì–‘": ["ë‹´ì–‘", "ì£½ë…¹ì›", "ë©”íƒ€ì„¸ì½°ì´ì–´"],
        "ìˆœì²œ": ["ìˆœì²œ", "êµ­ê°€ì •ì›", "ì„ ì•”ì‚¬", "ë‚™ì•ˆìì„±"],
        "ì—¬ìˆ˜": ["ì—¬ìˆ˜", "ì˜¤ë™ë„", "í–¥ì¼ì•”"],
        "ë³´ì„±": ["ë³´ì„±", "ë…¹ì°¨ë°­"],
        "ì‹ ì•ˆ": ["ì‹ ì•ˆ", "í¼í”Œì„¬"],
        "ëª©í¬": ["ëª©í¬", "ì¼€ì´ë¸”ì¹´"],
        "êµ¬ë¡€": ["êµ¬ë¡€", "í™”ì—„ì‚¬", "ì‚°ìˆ˜ìœ "]
    },
    "ê²½ë¶ (ëŒ€êµ¬/ê²½ì£¼)": {
        "ëŒ€êµ¬": ["ëŒ€êµ¬", "íŒ”ê³µì‚°", "ê¹€ê´‘ì„", "ì„œë¬¸ì‹œì¥"],
        "ê²½ì£¼": ["ê²½ì£¼", "ë¶ˆêµ­ì‚¬", "í™©ë¦¬ë‹¨ê¸¸"],
        "ì•ˆë™": ["ì•ˆë™", "í•˜íšŒë§ˆì„"],
        "ì²­ì†¡": ["ì²­ì†¡", "ì£¼ì™•ì‚°", "ì–¼ìŒí­í¬", "ì–¼ìŒê³¨", "í˜‘ê³¡ë¹„ê²½"],
        "ë´‰í™”": ["ë´‰í™”", "ë°±ë‘ëŒ€ê°„ìˆ˜ëª©ì›", "ë¶„ì²œ", "ì‚°íƒ€ë§ˆì„", "í˜‘ê³¡ì—´ì°¨"],
        "í¬í•­": ["í¬í•­", "í˜¸ë¯¸ê³¶", "ìŠ¤í˜ì´ìŠ¤ì›Œí¬"],
        "ìš¸ë¦‰ë„": ["ìš¸ë¦‰ë„", "ë…ë„"],
        "ë¬¸ê²½": ["ë¬¸ê²½", "ìƒˆì¬"],
        "ì˜ì£¼": ["ì˜ì£¼", "ë¶€ì„ì‚¬"]
    },
    "ë¶€ì‚° / ê²½ë‚¨ (ë‚¨í•´)": {
        "ë¶€ì‚°": ["ë¶€ì‚°", "íƒœì¢…ëŒ€", "ì†¡ë„", "í•´ìš´ëŒ€", "ìê°ˆì¹˜", "ì—˜ì‹œí‹°", "í•´ë³€ì—´ì°¨"],
        "ë‚¨í•´": ["ë‚¨í•´", "ë…ì¼ë§ˆì„", "ë³´ë¦¬ì•”"],
        "í†µì˜": ["í†µì˜", "ë™í”¼ë‘"],
        "ê±°ì œ": ["ê±°ì œ", "ì™¸ë„", "ë°”ëŒì˜ì–¸ë•"],
        "ì§„í•´": ["ì§„í•´", "ì—¬ì¢Œì²œ", "ê²½í™”ì—­"],
        "í•˜ë™": ["í•˜ë™", "ìµœì°¸íŒëŒ"]
    },
    "ì œì£¼ë„": {
        "ì œì£¼": ["ì œì£¼", "ì„±ì‚°ì¼ì¶œë´‰", "ìš°ë„", "ì—ì½”ëœë“œ"]
    }
}

def send_telegram_msg(text):
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": text}
    try: requests.post(url, data=payload, timeout=10)
    except: pass

def classify_location(title):
    # ì œëª©ì—ì„œ í‚¤ì›Œë“œ ë§¤ì¹­
    for province_display, cities in LOCATION_MAP.items():
        for city_name, keywords in cities.items():
            if any(keyword in title for keyword in [city_name] + keywords):
                return province_display, city_name
    return "ê¸°íƒ€", "ê¸°íƒ€"

def run_parent_classification():
    conn = get_db_connection()
    conn.autocommit(True)
    unclassified_list = [] 
    
    try:
        with conn.cursor() as cursor:
            # ì „ì²´ ìƒí’ˆ ê°€ì ¸ì˜¤ê¸°
            cursor.execute("SELECT product_code, title, agency, province, city FROM tours")
            parents = cursor.fetchall()
            
            logging.info(f"ğŸš€ 8ëŒ€ ê¶Œì—­ ê¸°ì¤€ìœ¼ë¡œ {len(parents)}ê±´ ì „ìˆ˜ì¡°ì‚¬ ì‹œì‘...")
            
            update_count = 0
            for p in parents:
                new_province, new_city = classify_location(p['title'])
                
                # ê¸°ì¡´ ë°ì´í„°ì™€ ë‹¤ë¥¼ ê²½ìš°ë§Œ ì—…ë°ì´íŠ¸ (DB ë¶€í•˜ ê°ì†Œ)
                if p['province'] != new_province or p['city'] != new_city:
                    cursor.execute("""
                        UPDATE tours 
                        SET province = %s, city = %s 
                        WHERE product_code = %s
                    """, (new_province, new_city, p['product_code']))
                    update_count += 1
                
                if new_province == "ê¸°íƒ€":
                    unclassified_list.append(f"[{p['agency']}] {p['title']}")
            
            logging.info(f"âœ¨ ì™„ë£Œ: {update_count}ê±´ì˜ ì§€ì—­ ì •ë³´ê°€ 8ëŒ€ ê¶Œì—­ ì´ë¦„ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            # ë¶„ë¥˜ ì‹¤íŒ¨ ëª©ë¡ ì¶œë ¥
            if unclassified_list:
                print("\n" + "="*50)
                print(f"ğŸš© ë¶„ë¥˜ ì‹¤íŒ¨ ëª©ë¡ ({len(unclassified_list)}ê±´)")
                print("="*50)
                for item in unclassified_list[:20]: # ë„ˆë¬´ ë§ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ìƒìœ„ 20ê°œë§Œ
                    print(item)
                print("..." if len(unclassified_list) > 20 else "")
                print("="*50 + "\n")

            # í…”ë ˆê·¸ë¨ ë¦¬í¬íŠ¸
            report_msg = f"âœ… [ì§€ì—­ë¶„ë¥˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ]\n- ì´ {len(parents)}ê±´ ì¤‘ {update_count}ê±´ ê°±ì‹ \n- ë¶„ë¥˜ ì‹¤íŒ¨(ê¸°íƒ€): {len(unclassified_list)}ê±´"
            send_telegram_msg(report_msg)

    finally:
        conn.close()

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    run_parent_classification()